"use strict";class Suranadira{constructor(e){this.properties=[],this.applyProperties(e),this.priorities={none:0,voices:1,characters:2,both:3},this.phases={none:0,elements:1,radicals:2,roots:3,words:4},this.syllablesColorCodingModes={none:0,allSyllables:1},this.charactersColorCodingModes={none:0,someComponentCycles:1,allComponentCycles:2,someElements:3,allElements:4,someLevels:5,allPhases:6},this.voicesColorCodingModes={none:0,groupVoices:1,allGroups:2},this.opacityTypes={opacityFull:1,opacityDimmed:.3,opacityNone:0},e={classEnabled:!0,debug:!1,user:null,overridePentade:null},this.applyProperties(e,!1),e={stage:$("#stage"),canvas:$("#canvas_sura"),canvas_:document.getElementById("canvas_sura"),canvasRC:$("#canvas_rc"),canvasCircles:$("#canvas_circles"),buffer:$("#buffer"),buffer2:$("#buffer2"),score:$("#score"),score2:$("#score2"),pentadeSelectorContainerID:"#pentade-selector-container",pentadeSelectorContainer:$("#pentade-selector-container"),pentadeSelectorClass:".pentade-selector",pentadeSelectors:$(".pentade-selector"),pentadeSelector:$("#pentade-selector")},this.applyProperties(e),e={unit:40,startLevel:0,endLevel:19,startExcerptCharacters:0,endExcerptCharacters:19,startExcerptVoices:0,endExcerptVoices:19,voicesPerGroup:4,singleStrand:!1,bufferMarginX:-5,preloadPositions:5,animateStepUnits:1,rcOffsetX:15,hideIdleCursorAfter:3},this.applyProperties(e),e={canvasAspectRatio:2.39,width:null,height:this.endLevel-this.startLevel+1,colors:["#4682B4","#3CB371","#800000","#FFD700","#8A2BE2","#2F4F4F"],colorsDimmed:[],backgroundColor:"black",strokeWidth:5,strokeWidthVoices:3,strokeWidthTruthGrid:1,opacityCharacters:1,opacityVoices:1,opacityCircles:1,opacityTruthGrid:.7,radiusCircles:Math.round(.18*this.unit)},this.applyProperties(e),e={priority:this.priorities.characters,trimCharacters:!1,markLevels:[1],markElements:[0,1,5],phaseMode:this.phases.roots,syllablesColorCodingMode:this.syllablesColorCodingModes.allSyllables,charactersColorCodingMode:this.charactersColorCodingModes.allElements,voicesColorCodingMode:this.voicesColorCodingModes.allGroups},this.applyProperties(e),e={secondsPerDay:86400,pentadesPerDay:Math.pow(2,12),scoreTempo:4218.75,useEra:!0},this.applyProperties(e),e={positionsPerDay:5*this.pentadesPerDay,msPerPosition:this.secondsPerDay/this.positionsPerDay*1e3,msPerPentade:5*this.msPerPosition,animationTempo:this.scoreTempo/4,animationEasing:"swing"},this.applyProperties(e),e={voicesEnabled:!0,circlesEnabled:!0,charactersEnabled:!0,truthGridEnabled:!1,syllablesEnabled:!1,animationEnabled:!0,scoreEnabled:!0,metronomeEnabled:!1,runtimeCommandsEnabled:!0},this.applyProperties(e,!1),e={dec:"",isLevelVisible:!1,currLevel:0,left:null,offsetX:0,offsetY:this.unit/2,mouseEventsAllowed:!0,stageTop:null,stageWidth:null,stageHeight:null,wesen:null,preloadedPosition:null,preloadedPentade:null,currentPosition:null,isSynchronizing:!1,circlesOffsetX:28,windowHeight:0,selectedPentade:0,bufferTime:0,timerSuranadira:null,timerWindowResizing:null,timerMouseMove:null,countBufferReloaded:0,bufferLocalPosition:0,groups:Math.floor(this.height/this.voicesPerGroup),audioContext:null,osc:null,workerRuntime:null,isInitialized:!1,fields:[],fieldsCache:[],voiceLevels:[],voiceLevels2:[],scoreBeats:[],scoreBeats2:[],partCurrent:null,pageCurrent:null,beatCurrent:null,partLast:63,beatStart:null,pageWidth:null,pageHeight:null,pageScale:1.71875,isPageLoaded:!1,scoreHeight:null,dn:[]},this.applyProperties(e),this.classEnabled&&this.activateWorkerRuntime()}recalculateProperties(){this.height=this.endLevel-this.startLevel+1,this.radiusCircles=Math.round(.18*this.unit),this.positionsPerDay=5*this.pentadesPerDay,this.msPerPosition=this.secondsPerDay/this.positionsPerDay*1e3,this.msPerPentade=5*this.msPerPosition,this.animationTempo=this.scoreTempo/4,this.offsetY=this.unit/2,this.groups=Math.floor(this.height/this.voicesPerGroup),this.updateCircles(),this.updateScore()}generateDimmedColors(){var e,t,s,i,r,o,a=this;$.each(this.colors,function(h,n){null!=(t=a.hexToRgb(n))?(s=a.rgbToHsl(t.r,t.g,t.b),i=s.h/1,r=s.s/1,o=s.l/5,t=a.hslToRgb(i,r,o),e=a.rgbToHex(t.r,t.g,t.b)):e=n,a.colorsDimmed[h]=e})}hideCircles(){this.canvasCircles.hide()}showCircles(){this.canvasCircles.show()}animateCircles(){this.height;var e,t=this.strokeWidthVoices/2,s=this.bufferTime+1+this.circlesOffsetX;try{for(var i=0;i<this.height;i++)i<this.startExcerptVoices||i>this.endExcerptVoices||(e=this.voiceLevels2[s][i],this.canvasCircles.stopLayer("circle"+i),this.canvasCircles.animateLayer("circle"+i,{y:e*this.unit+this.offsetY+t},{duration:this.animationTempo,easing:this.animationEasing,complete:function(e){0}}))}catch(e){console.log(e)}this.bufferTime++}isLastPage(){return this.pageCurrent>=this.getLastPageID()}getLastPageID(){return this.partCurrent<62?9:10}loadScoreToBuffer(e,t){this.showDebugInfo("loadScoreToBuffer","part: "+e+", page: "+t);var s=this;$(this.score2).attr("src","controller/get_png.php?part-last="+this.partLast+"&part="+e+"&page="+t+"&r="+Math.random()),$(this.score2).on("load",function(){s.isPageLoaded||(s.loadScoreFromBuffer(0),s.animateScore(!1,!0),s.gotoBeat(s.beatStart),s.startTimer(),s.beatStart>3&&(s.isLastPage()?s.partCurrent<s.partLast?s.workerRuntime.postMessage(["retrieve-metronome",s.user,s.partCurrent+1,1]):s.workerRuntime.postMessage(["retrieve-metronome",s.user,1,1]):s.workerRuntime.postMessage(["retrieve-metronome",s.user,s.partCurrent,s.pageCurrent+1])))})}gotoBeat(e){for(var t=1;t<e+1;t++)this.animateScore(!0,!0)}loadScoreFromBuffer(e){this.showDebugInfo("loadScoreFromBuffer","part: "+this.partCurrent+", page: "+this.pageCurrent);var t=(this.circlesOffsetX-this.preloadPositions)*this.unit-2*this.pageWidth/this.pageScale-e/this.pageScale-3;$(this.score2).offset({left:t}),this.scoreEnabled&&(this.show(this.score2),this.hide(this.score)),$(this.score).attr("src",$(this.score2).attr("src")),$(this.score).offset({left:t}),this.scoreEnabled&&(this.show(this.score),this.hide(this.score2),this.updateCircles()),this.isPageLoaded=!0}animateScore(e,t){if(this.isPageLoaded&&this.scoreBeats2.length){void 0===e&&(e=!0),void 0===t&&(t=!1);var s,i,r=this;null==this.beatCurrent&&(this.beatCurrent=0,this.showDebugInfo("beatCurrent",this.beatCurrent)),0==this.beatCurrent&&(s=this.scoreBeats.length>0?this.scoreBeats.pop():0,this.scoreBeats=this.scoreBeats2.slice(),i=this.scoreBeats[0],this.scoreBeats[0]+=s,e&&(this.pageCurrent++,this.pageCurrent>this.getLastPageID()&&(this.partCurrent++,this.partCurrent>this.partLast&&(this.partCurrent=1),this.showDebugInfo("partCurrent",this.partCurrent),this.pageCurrent=1),this.showDebugInfo("pageCurrent",this.pageCurrent))),this.score.animate({left:"-="+this.scoreBeats[this.beatCurrent]/this.pageScale},t?-1:this.animationTempo,function(){$(r.score2).offset({left:$(r.score).offset().left}),0==r.beatCurrent&&r.loadScoreFromBuffer(i),r.beatCurrent++,r.beatCurrent%=r.scoreBeats.length-1,r.showDebugInfo("beatCurrent",r.beatCurrent),3==r.beatCurrent&&(r.isLastPage()?r.partCurrent<r.partLast?r.workerRuntime.postMessage(["retrieve-metronome",r.user,r.partCurrent+1,1]):r.workerRuntime.postMessage(["retrieve-metronome",r.user,1,1]):r.workerRuntime.postMessage(["retrieve-metronome",r.user,r.partCurrent,r.pageCurrent+1]))})}}animateBuffer(){var e=this;this.pentadeSelectorContainer.animate({left:"-="+e.unit*e.animateStepUnits},e.animationTempo,function(){}),e.buffer.animate({left:"-="+e.unit*e.animateStepUnits},e.animationTempo,function(){e.preloadedPentade=e.preloadedPentade.plus(e.animateStepUnits/5),e.showDebugInfo("preloadedPentade",e.preloadedPentade),e.currentPosition=e.currentPosition.plus(1),e.showDebugInfo("currentPosition",e.currentPosition),e.bufferLocalPosition%5==0?(e.calcDeltaForPentades(),e.runtimeCommandsEnabled&&e.workerRuntime.postMessage(["retrieve-configuration",e.user])):e.bufferLocalPosition%5==2?(e.preloadedPosition=e.preloadedPosition.plus(e.preloadPositions),e.showDebugInfo("preloadedPosition",e.preloadedPosition.toString()),e.synchronizeSuranadira(e.preloadedPosition),e.getVoiceLevels(e.getVoiceLevelsCurrent()),e.canvas.removeLayers(),e.drawSuranadira()):e.bufferLocalPosition%5==4&&(e.pentadeSelectors.trigger("mouseleave"),e.pentadeSelectorContainer.stop(),e.loadFromBuffer(!0)),e.bufferLocalPosition+=1,e.bufferLocalPosition%=5,e.showDebugInfo("bufferLocalPosition",e.bufferLocalPosition)})}drawSuranadira(){switch(this.priority){case this.priorities.characters:this.opacityVoices=this.opacityTypes.opacityDimmed,this.opacityCharacters=this.opacityTypes.opacityFull;break;case this.priorities.none:this.opacityVoices=this.opacityTypes.opacityDimmed,this.opacityCharacters=this.opacityTypes.opacityDimmed;break;case this.priorities.both:this.opacityVoices=this.opacityTypes.opacityFull,this.opacityCharacters=this.opacityTypes.opacityFull;break;default:this.opacityVoices=this.opacityTypes.opacityFull,this.opacityCharacters=this.opacityTypes.opacityDimmed}this.canvas.prop("width",this.width*this.unit);var e=this.charactersEnabled&&!this.trimCharacters?1:0;this.canvas.prop("height",(this.height+e)*this.unit),this.drawBackground(this.canvas),this.truthGridEnabled&&this.drawTruthGrid(this.canvas),this.priority==this.priorities.voices?(this.charactersEnabled&&this.drawCharacters(this.canvas),this.voicesEnabled&&this.drawVoices(this.canvas)):(this.voicesEnabled&&this.drawVoices(this.canvas),this.charactersEnabled&&this.drawCharacters(this.canvas)),this.syllablesEnabled&&this.drawSyllables(this.canvas),this.saveToBuffer()}drawRC(e){this.dec=e,this.canvasRC.removeLayers(),this.canvasRC.drawLayers(),this.compose(!1,this.canvasRC,1)}drawComponent(e,t,s,i,r,o,a,h,n){switch(n|=0,!h&&$.inArray(t,["Z","S","O","I"])<0&&(o>this.rcOffsetX+6&&s&&"N"==t&&(o-=6),o<this.rcOffsetX-6&&!s&&"U"==t&&(o+=6)),"V"==t||"I"==t||"O"==t||(this.singleStrand=!1),t){case"J":o+=i<2?-2:-1,a=this.drawStretch(e,"H",t,i-1,o,a,n),this.drawElement(e,"J",t,i<2?o:o-1,a,n),o+=i<2?0:-1,s=i<2;break;case"V":o-=1,a=this.drawStretch(e,"H",t,i-1,o,a,n),this.drawElement(e,"V",t,o,a,n),o+=1;break;case"I":this.drawElement(e,this.singleStrand?"I":"II",t,o,a,n),a+=1;break;case"U":o+=s?0:-3,s=!0,this.drawElement(e,"IA",t,o,a,n),a+=1,a=this.drawStretch(e,"M",t,i,o,a,n),this.drawElement(e,"VI",t,o,a,n),o+=1,s=!1;break;case"N":o+=s?2:-1,s=!1,this.drawElement(e,"AI",t,o,a,n),a++,a=this.drawStretch(e,"M",t,i,o,a,n),this.drawElement(e,"IV",t,o,a,n),s=!0;break;case"O":s?(this.drawElement(e,"IA",t,o,a,n),a+=1,a=this.drawStretch(e,"M",t,i,o,a,n),this.drawElement(e,"IV",t,o,a,n)):(o-=1,this.drawElement(e,this.singleStrand?"A":"AI",t,o,a,n),a+=1,a=this.drawStretch(e,this.singleStrand?"H":"M",t,this.singleStrand?i-2:i,o,a,n),this.drawElement(e,this.singleStrand?"V":"VI",t,o,a,n),o+=1);break;case"Z":"I1J1"==r?o+=2:(a==this.endLevel-1?o+=-1:o+=s?i%2==0?-1:-4:-1,s=!s),this.drawElement(e,"ZZ",t,o,a,n),"I1J1"==r||(o+=s?0:i%2==0?0:3);break;case"S":a>=this.endLevel?o+=0:o+=s?0:i%2==0?0:-3,this.drawElement(e,"SS",t,o,a,n),o+=(s=!s)?i%2==0?1:-2:1}return{strand:s,x:o}}drawCharacters(e,t){t=0;var s,i,r=new Big(this.preloadedPosition),o=this.trimCharacters?1:0;this.offsetX=-this.offsetY;for(var a=0;a<this.height-o;a++)if(!(a<this.startExcerptCharacters||a>this.endExcerptCharacters)){s=[];for(var h=0;h<this.width;h++)i=r.plus(h),s[0]=this.logos(i,a),s[1]=this.logos(i.minus(1),a+1),s[2]=this.logos(i.plus(1),a+1),0==s[0]&&(t=this.getCharactersColor(i,a),s[1]&&s[2]?this.drawStroke(e,["suranadira","stroke-0","color-"+t],0,h,a,t):(s[1]||this.drawStroke(e,["suranadira","stroke-1","color-"+t],1,h,a,t),s[2]||this.drawStroke(e,["suranadira","stroke-2","color-"+t],2,h,a,t)))}this.moveForwardSelectedElements(e)}moveForwardSelectedElements(e){var t=e.getLayerGroup("color-1");$.each(t,function(t,s){e.moveLayer(s,2e3)}),e.drawLayers()}drawVoices(e){var t,s,i=1,r=this.strokeWidthVoices/2;t=this.priority==this.priorities.voices||this.priority==this.priorities.both?this.colors:this.colorsDimmed;for(var o={layer:!0,groups:["suranadira","voices","voice-"+a],rounded:!0,closed:!1,opacity:1,strokeWidth:2*r},a=0;a<this.height;a++)if(!(a<this.startExcerptVoices||a>this.endExcerptVoices)){for(var h=0;h<this.width;h++)s=this.voiceLevels[h][a],o["x"+(h+1)]=h*this.unit,o["y"+(h+1)]=s*this.unit+this.offsetY+r,i=this.getVoiceColor(h,a),o.strokeStyle=t[i];e.drawLine(o)}}drawCircles(){var e,t=this.colors,s=0,i=this.strokeWidthVoices/2;e={layer:!0,groups:["suranadira","circles"],x:3*this.unit,radius:this.radiusCircles,visible:!1,opacity:.7};for(var r,o=this.bufferTime+0+this.circlesOffsetX,a=0;a<this.height;a++)r=this.voiceLevels2[o][a],e.name="circle"+a,s=this.getVoiceColor(o,a),e.fillStyle=t[s],e.y=this.unit*r+this.offsetY+i,this.canvasCircles.drawArc(e)}updateScore(){this.scoreEnabled?this.showScore():this.hideScore()}updateCircles(){var e=this,t=this.colors,s=0,i=this.canvasCircles.getLayerGroup("circles");if(void 0!==i){var r,o=this.bufferTime+0+this.circlesOffsetX;$.each(i,function(i,a){r=a.index,s=e.getVoiceColor(o,r),a.fillStyle=t[s],a.visible=!(r<e.startExcerptVoices||r>e.endExcerptVoices)})}this.circlesEnabled?this.showCircles():this.hideCircles(),this.canvasCircles.drawLayers()}drawStretch(e,t,s,i,r,o,a){switch(a|=0,t){case"H":for(var h=0;h<i;h++)this.drawElement(e,"H",s,r,o,a),o++;break;case"M":for(h=2;h<i;h++)this.drawElement(e,"M",s,r,o,a),o++}return o}drawElement(e,t,s,i,r,o){switch(o|=0,t){case"H":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i-1,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+1,r,o);break;case"M":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i-1,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+1,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+3,r,o);break;case"J":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+2,r,o);break;case"I":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i-1,r,o);break;case"II":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i-1,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+2,r,o);break;case"A":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+0,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+0,r,o);break;case"AI":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+0,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+0,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+3,r,o);break;case"IA":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+-1,r,o),this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+2,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+2,r,o);break;case"V":this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i-1,r,o),this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+1,r,o);break;case"IV":this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i-1,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+1,r,o),this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+3,r,o);break;case"VI":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+1,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+-1,r,o),this.drawStroke(e,["stroke-0","element-"+t,"component-"+s,"level-"+this.currLevel],0,i+3,r,o);break;case"S":this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i-1,r,o);break;case"SS":this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i-1,r,o),this.drawStroke(e,["stroke-2","element-"+t,"component-"+s,"level-"+this.currLevel],2,i+2,r,o);break;case"Z":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+0,r,o);break;case"ZZ":this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+0,r,o),this.drawStroke(e,["stroke-1","element-"+t,"component-"+s,"level-"+this.currLevel],1,i+3,r,o)}}drawStroke(e,t,s,i,r,o){o|=0;if(r<this.startLevel||r>=this.endLevel+1)this.isLevelVisible=!1;else{this.isLevelVisible=!0;var a={layer:!0,groups:t,strokeStyle:(this.priority==this.priorities.characters||this.priority==this.priorities.both?this.colors:this.colorsDimmed)[o],rounded:!0,closed:!1,opacity:1,strokeWidth:this.strokeWidth,mousedown:function(t){var s=t.groups[3].split("-");e.triggerLayerEvent("hotspot-"+s[1],"mousedown")},mouseup:function(t){if(t.groups.length>3){var s=t.groups[3].split("-");e.triggerLayerEvent("hotspot-"+s[1],"mouseup")}},mouseover:function(t){if(t.groups.length>3){var s=t.groups[3].split("-");e.triggerLayerEvent("hotspot-"+s[1],"mouseover")}},mouseout:function(t){if(t.groups.length>3){var s=t.groups[3].split("-");e.triggerLayerEvent("hotspot-"+s[1],"mouseout")}}};switch(s){case 0:a.x1=this.unit+i*this.unit+this.offsetX,a.y1=0+r*this.unit+this.offsetY-this.startLevel*this.unit,a.x2=this.unit+i*this.unit+this.offsetX,a.y2=this.unit+r*this.unit+this.offsetY-this.startLevel*this.unit;break;case 1:a.x1=this.unit+i*this.unit+this.offsetX,a.y1=0+r*this.unit+this.offsetY-this.startLevel*this.unit,a.x2=0+i*this.unit+this.offsetX,a.y2=this.unit+r*this.unit+this.offsetY-this.startLevel*this.unit;break;case 2:a.x1=this.unit+i*this.unit+this.offsetX,a.y1=0+r*this.unit+this.offsetY-this.startLevel*this.unit,a.x2=2*this.unit+i*this.unit+this.offsetX,a.y2=this.unit+r*this.unit+this.offsetY-this.startLevel*this.unit}e.drawLine(a)}}drawSyllables(e,t){for(var s,i,r,o,a,h,n=new Big(this.preloadedPosition),l=this.offsetY,c=this.strokeWidthVoices/2,d=0;d<this.height-0;d++){d*this.unit+this.offsetY;for(var u=0;u<this.width;u++)s=n.plus(u),0==this.logos(s,d)&&(i=u*this.unit+l+this.unit/2,r=d*this.unit+this.offsetY+c,0==this.logos(s.plus(2),d)?(o=i+this.unit,h=0):(o=i+2*this.unit,h=1),a=r,this.drawSyllableLine(e,i,r,o,a,0,h))}}drawSyllableLine(e,t,s,i,r,o,a){o=this.syllablesColorCodingMode==this.syllablesColorCodingModes.allSyllables?0==a?0:1:0;var h={layer:!0,groups:["syllables","syllable-type-"+a,"syllable-line-"+s],rounded:!0,closed:!1,opacity:1,strokeWidth:2*(this.strokeWidthVoices/2),strokeStyle:this.colors[o],x1:t,x2:i,y1:s,y2:r};e.drawLine(h)}drawSyllableCircle(e,t,s,i){var r;r={layer:!0,groups:["syllables","syllable-circle"],x:t,y:s,radius:this.unit/2,opacity:1,name:"syllable-circle-"+t+"-"+s,fillStyle:this.backgroundColor},e.drawArc(r)}drawHotspot(e,t,s,i,r){var o=this;e.drawRect({name:"hotspot-"+this.currLevel,groups:["id-"+t],layer:!0,x:(i-1)*this.unit+this.offsetX,y:r*this.unit+this.offsetY,width:5*this.unit,height:s*this.unit,fromCenter:!1,mousedown:function(t){var s=t.name.split("-");o.markLevel(s[1],1),e.drawLayers()},mouseup:function(t){var s=t.name.split("-");t.groups[0].split("-");o.markLevel(s[1],2),e.drawLayers(),o.wesen=s[1],console.log(o.wesen)},mouseover:function(e){var t=e.name.split("-");o.markLevel(t[1],2)},mouseout:function(e){var t=e.name.split("-");o.markLevel(t[1],0)}})}drawModules(e,t,s){for(var i=0;i<=this.height;i+=4)i>0&&i<this.height&&this.drawModule(e,t,s+i)}drawModule(e,t,s){var i={layer:!0,strokeStyle:this.colors[1],rounded:!0,closed:!1,opacity:1,strokeWidth:1,x1:0};i.y1=0+s*this.unit+this.offsetY-this.startLevel*this.unit,i.x2=this.stageWidth,i.y2=0+s*this.unit+this.offsetY-this.startLevel*this.unit,e.drawLine(i)}drawTruthGrid(e,t){t|=5;for(var s={layer:!0,groups:["truth-grid"],strokeStyle:this.colors[t],rounded:!0,closed:!1,opacity:this.opacityTruthGrid,strokeWidth:this.strokeWidthTruthGrid},i=parseInt(this.preloadedPentade.minus(this.preloadedPentade.mod(1)).mod(2)),r=-this.offsetY,o=this.charactersEnabled&&!this.trimCharacters?1:0,a=(this.height+o)*this.unit,h=0;h<this.width;h+=2)s.x1=h*this.unit+(this.countBufferReloaded%2?-r:r),0==this.countBufferReloaded?i&&(s.x1-=2*r):i==this.countBufferReloaded%2&&(s.x1-=2*r),s.x2=s.x1,s.y1=0,s.y2=a,e.drawLine(s)}drawBackground(e){var t=this.charactersEnabled&&!this.trimCharacters?1:0;e.removeLayer("background"),e.drawRect({name:"background",layer:!0,fillStyle:this.backgroundColor,x:0,y:0,width:this.width*this.unit,height:(this.height+t)*this.unit,fromCenter:!1})}loadEvents(){var e=this;$(window).resize(function(t){e.haveStageDimensionsChanged()&&(clearTimeout(e.timerWindowResizing),e.timerWindowResizing=setTimeout(function(){e.reload()},250),t.stopImmediatePropagation())}),$("body").mousemove(function(){e.hideIdleCursor()}),$(window).on("unload",function(){null!=e.workerRuntime&&e.workerRuntime.terminate()})}hideIdleCursor(){var e=this;clearTimeout(e.timerMouseMove),e.showCursor(),e.timerMouseMove=setTimeout(function(){e.hideCursor()},1e3*e.hideIdleCursorAfter)}showCursor(){$("body").hasClass("cursor-hidden")&&$("body").removeClass("cursor-hidden")}hideCursor(){$("body").hasClass("cursor-hidden")||$("body").addClass("cursor-hidden")}reload(e){this.stopTimer(),$("#reload").trigger("click")}applyProperties(e,t){for(var s in void 0===t&&(t=!0),e)(t||void 0===this[s])&&(this[s]=e[s],this.properties[s]=e[s])}getProperties(){return this.properties}updateProperty(e,t){this.properties[e]=t}init(){this.hide(this.buffer2),this.hide(this.buffer),this.hide(this.canvasRC),this.hide(this.score2),this.hide(this.score),this.generateDimmedColors(),this.resizeStage(),this.redraw(),this.loadScore(),this.requireLazy(),this.hideCursor(),this.activateAudioContext()}loadScore(){this.isPageLoaded=!1;var e=this.currentPosition.mod(10240).plus(0),t=this.getScorePosition(e);this.showDebugInfo("startPositionDay",e+" ("+t+")"),this.partCurrent=t[0],this.pageCurrent=t[1],this.beatStart=t[2],this.showDebugInfo("partCurrent",this.partCurrent),this.showDebugInfo("pageCurrent",this.pageCurrent),this.workerRuntime.postMessage(["retrieve-metronome",this.user,this.partCurrent,this.pageCurrent])}getScorePosition(e){if((e=parseInt(e))<9882)var t=Math.floor(e/162)+1,s=Math.floor(e/18)%9+1,i=e%18+1;else if(e<10062){e-=9882;t=62,s=Math.floor(e/18)%10+1,i=e%18+1}else{e-=10062;t=63,s=Math.floor(e/18)%10+1,i=e%18+1}return 63==t&&10==s?16==i&&(i=15):18==i&&(i=17),[t,s,i]}activateAudioContext(){this.audioContext=new AudioContext}loadConfiguration(e){var t=this;if("empty"!=e){var s=JSON.parse(e),i=t.endLevel,r=t.unit;t.voicesEnabled,t.charactersEnabled,t.truthGridEnabled,t.scoreEnabled;$.each(s,function(e,s){switch(s[2]){case"boolean":s[1]="true"===s[1];break;case"number":s[1]=parseInt(s[1]);break;case"array":s[1]=JSON.parse(s[1]);break;case"sarray":s[1]=s[1].split(",")}t[s[0]]=s[1],t.properties[s[0]]=s[1],t.showDebugInfo("runtimeCommand",s[0]+" = "+s[1])}),t.isInitialized?t.endLevel!=i||t.unit!=r?t.reload():(t.recalculateProperties(),t.resizeStage()):t.recalculateProperties()}}initAndLoadEvents(){this.init(),this.loadEvents(),this.isInitialized=!0}activateWorkerRuntime(){var e=this;this.workerRuntime=new Worker("model/class.suranadira.runtime.js"),null==this.user?this.workerRuntime.postMessage(["retrieve-user",getCookie("suranadira-user"),getCookie("pairing-guid"),getCookie("pairing-code")]):this.workerRuntime.postMessage(["retrieve-configuration",this.user]),this.workerRuntime.onmessage=function(t){if(!e.isSynchronizing&&"empty"!=t.data[1]&&t.isTrusted&&t.data[0].length)switch(t.data[0]){case"user":e.user=t.data[1],setCookie("suranadira-user",e.user,3650),e.workerRuntime.postMessage(["retrieve-configuration",e.user]);break;case"configuration":e.loadConfiguration(t.data[1]),e.isInitialized||e.initAndLoadEvents();break;case"metronome":e.scoreBeats2=JSON.parse(t.data[1]),e.pageWidth=t.data[2],e.pageHeight=t.data[3],e.isPageLoaded?e.isLastPage()?e.partCurrent<e.partLast?e.loadScoreToBuffer(e.partCurrent+1,1):e.loadScoreToBuffer(1,1):e.loadScoreToBuffer(e.partCurrent,e.pageCurrent+1):e.loadScoreToBuffer(e.partCurrent,e.pageCurrent)}}}reset(){this.stopTimer(),this.pentadeSelectors.off("mouseup"),$("#debug").html(""),$("#stage").html($("#stage").html())}requireLazy(){var e=this;$.getScript("js/fields.js",function(){for(var t in fields)e.addField(fields[t],$("#"+fields[t]))})}showDebugInfo(e,t){void 0!==this.fields[e]&&this.fields[e].text(t),this.fieldsCache[e]=t}refreshDebugInfo(){for(var e in this.fieldsCache)void 0!==this.fieldsCache[e]?this.showDebugInfo(e,this.fieldsCache[e].toString()):console.log("Undefined debug key: "+e)}addField(e,t){this.fields[e]=t}hide(e){e.css("opacity",0).css("z-index",-1)}show(e){e.css("opacity",1).css("z-index",1e3)}isVisible(e){return 0!=e.css("opacity")}startTimer(){if(null==this.timerSuranadira){var e=this,t=!1,s=!1;this.timerSuranadira=setInterval(function(){var i=new Date,r=new Big(i.getTime()-e.tzOffset()),o=new Big(r.div(e.scoreTempo));o=o.round(5).mod(1);var a=parseFloat(o.minus(.4));o=parseFloat(o),!t&&o>=.4&&o<.5?(t=!0,e.getStageWidth(!1),e.fireMetronomeTick(),e.animateBuffer(),e.animateScore(),e.animateCircles(),e.showDebugInfo("timerPrecision",a),e.debug&&e.refreshDebugInfo()):t&&o<.4&&(t=!1,s=!1),t&&!s&&o>=.9&&o<1&&(s=!0,e.fireMetronomeTick())},1)}}fireMetronomeTick(){if(this.metronomeEnabled){var e=this.audioContext.createGain();e.connect(this.audioContext.destination),this.osc=this.audioContext.createOscillator(),this.osc.connect(e),e.gain.value=.5,this.osc.type="sine",this.osc.frequency.value=440;var t=this.audioContext.currentTime;this.osc.start(t),this.osc.stop(t+.05)}}stopTimer(){null!=this.timerSuranadira&&(clearInterval(this.timerSuranadira),this.timerSuranadira=null)}getStageWidth(e){var t;if(t=$(window).width(),e)return t;this.stageWidth=t}getStageHeight(e,t){void 0===t&&(t=this.stageWidth);var s,i=t/this.canvasAspectRatio;s=i,this.windowHeight=$(window).height();var r=.7*this.windowHeight;r-=r%this.unit+this.offsetY,s>this.windowHeight?s=this.windowHeight:s<r&&(s=r);var o=this.charactersEnabled&&!this.trimCharacters?1:0,a=(this.height+o)*this.unit;if(a<=i&&s<a&&(s=(this.height+o)*this.unit),e)return s;this.stageHeight=s}setupPentadeSelectors(){var e;this.pentadeSelectors.remove(),this.pentadeSelectorContainer.css("width",this.width*this.unit),this.pentadeSelectorContainer.css("height",this.height*this.unit);for(var t=0;t<Math.ceil(this.width/5);t++)(e=this.pentadeSelector.clone()).appendTo(this.pentadeSelectorContainerID),e.attr("id","pentade-selector-"+t),e.attr("pentade-selector",t),e.addClass("pentade-selector"),e.css("top","0px"),e.css("width",5*this.unit+"px"),e.css("height",(this.height-1)*this.unit+"px"),e.css("opacity",this.debug?"1":"0");this.pentadeSelectors=$(this.pentadeSelectorClass)}setupPentadeSelectorEvents(){if(this.debug){var e=this;this.pentadeSelectors.on("mouseup",function(t){e.hideSuranadira();var s=$(t.target).attr("pentade-selector");e.showDebugInfo("bufferLocalPentade",s);var i=$(this).attr("pentade");e.showDebugInfo("selectedPentade",i.toString());var r=$(this).offset().left;e.drawRC(i),e.showRC(r)})}}showRC(e){this.canvasRC.offset({left:e-this.rcOffsetX*this.unit+3*this.unit}),this.show(this.canvasRC)}hideRC(){this.canvasRC.hide()}hideSuranadira(){this.hide(this.buffer),this.hide(this.pentadeSelectorContainer),this.hide(this.canvasCircles)}showSuranadira(){this.show(this.buffer),this.show(this.pentadeSelectorContainer),this.hide(this.canvasRC),this.show(this.canvasCircles)}hideScore(){this.hide(this.score2),this.hide(this.score)}showScore(){this.show(this.score),this.show(this.score2)}onSuranadiraLoaded(){this.showSuranadira(),this.keyboardInteractions()}keyboardInteractions(){var e=this;$(document).keyup(function(t){switch(t.keyCode){case 27:e.debug&&e.showSuranadira();break;case 32:e.debug&&(console.log("Simulating out of sync"),e.preloadedPosition=e.preloadedPosition.minus(20));break;case 82:t.shiftKey&&e.debug&&e.updateProperty("endLevel",11);break;case 84:e.debug&&(e.reload(),t.stopImmediatePropagation())}})}getJacobsthal(e){if(e<0)return Math.pow(2,e);for(var t=[0,1],s=2;s<e+1&&(t[s]=Big(t[s-1]).plus(Big(2).mul(Big(t[s-2]))),!(s>=e));s++);return t[e]}markComponentCyclesSome(e,t){var s=e.div(5);s=s.minus(s.mod(1));var i,r,o=this.dn[s.toString()],a=0;for(var h in o)for(var n in a+=o[h],i=0,this.markLevels)if(a==(r=this.markLevels[n])&&(i=o[h],t<r&&t>=r-i))return parseInt(n)+1;return 0}markComponentCyclesAll(e,t){var s=e.div(5);s=s.minus(s.mod(1));var i,r=this.dn[s.toString()],o=0;for(var a in r)if(o+=r[a],i=r[a],t<o&&t>=o-i)return o%2+0;return 0}markElementsAll(e,t){var s=e.mod(5*Math.pow(2,t+1)),i=1+2*(Math.pow(2,t)+(t%2?0:1))-1,r=i+6*this.getJacobsthal(t)-1,o=r+6*this.getJacobsthal(t-1),a=o+6*this.getJacobsthal(t)-(t%2?3:0),h=a+3*Math.pow(2,t);return s.cmp(1)<1?0:s.cmp(i)<1?2:s.cmp(r)<1?0:s.cmp(o)<1?1:s.cmp(a)<1?1:s.cmp(h)<1?2:0}markElementsSome(e,t){var s=e.mod(5*Math.pow(2,t+1)),i=1+2*(Math.pow(2,t)+(t%2?0:1))-1,r=i+6*this.getJacobsthal(t)-1,o=r+6*this.getJacobsthal(t-1),a=o+6*this.getJacobsthal(t)-(t%2?3:0),h=a+3*Math.pow(2,t);return $.inArray(0,this.markElements)>=0&&s.cmp(1)<1?1:$.inArray(1,this.markElements)>=0&&s.cmp(1)>0&&s.cmp(i)<1?1:$.inArray(2,this.markElements)>=0&&s.cmp(i)>0&&s.cmp(r)<1?1:$.inArray(3,this.markElements)>=0&&s.cmp(r)>0&&s.cmp(o)<1?1:$.inArray(4,this.markElements)>=0&&s.cmp(o)>0&&s.cmp(a)<1?1:$.inArray(5,this.markElements)>=0&&s.cmp(a)>0&&s.cmp(h)<1?1:0}markPhasesAll(e,t){if(!(this.phaseMode<this.phases.elements))return Math.floor(t/this.phaseMode)%2}markLevelsSome(e,t){for(var s in this.markLevels)if(t+1==this.markLevels[s])return 1;return 0}getCharactersColor(e,t){switch(this.charactersColorCodingMode){case this.charactersColorCodingModes.someComponentCycles:return this.markComponentCyclesSome(e,t);case this.charactersColorCodingModes.allComponentCycles:return this.markComponentCyclesAll(e,t);case this.charactersColorCodingModes.allElements:return this.markElementsAll(e,t);case this.charactersColorCodingModes.someElements:return this.markElementsSome(e,t);case this.charactersColorCodingModes.allPhases:return this.markPhasesAll(e,t);case this.charactersColorCodingModes.someLevels:return this.markLevelsSome(e,t);default:return 0}}calcDeltaForPentades(){if(this.charactersColorCodingMode!=this.charactersColorCodingModes.none)for(var e,t,s=this.preloadedPentade.minus(this.preloadedPentade.mod(1)),i=0;i<Math.ceil(this.width/5);i++)e=(t=s.plus(i)).toString(),void 0===this.dn[e]&&(this.dn[e]=this.dec2delta(t).reverse())}getVoiceColor(e,t){switch(this.voicesColorCodingMode){case this.voicesColorCodingModes.groupVoices:return t%this.voicesPerGroup;case this.voicesColorCodingModes.allGroups:return Math.floor(t/this.voicesPerGroup)%2;default:return 0}}saveToBuffer(){this.buffer2.attr("src",this.canvas_.toDataURL())}loadFromBuffer(e){if((e|=!1)&&(this.buffer2.offset({left:this.buffer.offset().left+this.unit*this.preloadPositions}),this.show(this.buffer2),this.buffer.hide()),this.buffer.attr("src",this.buffer2.attr("src")),e){this.buffer.offset({left:this.buffer.offset().left+this.unit*this.preloadPositions}),this.buffer.show(),this.hide(this.buffer2);this.buffer.offset().left;this.resetPentadeSelectorContainer()}this.assignPentadesToSelectors(),this.fetchVoiceLevels(),this.updateAppearance(),this.countBufferReloaded++,this.showDebugInfo("countBufferReloaded",this.countBufferReloaded)}updateAppearance(){switch(this.priority){case this.priorities.characters:this.opacityVoices=this.opacityTypes.opacityDimmed,this.opacityCircles=this.opacityTypes.opacityDimmed,this.opacityCharacters=this.opacityTypes.opacityFull;break;case this.priorities.none:this.opacityVoices=this.opacityTypes.opacityDimmed,this.opacityCircles=this.opacityTypes.opacityDimmed,this.opacityCharacters=this.opacityTypes.opacityDimmed;break;case this.priorities.both:this.opacityVoices=this.opacityTypes.opacityFull,this.opacityCircles=this.opacityTypes.opacityFull,this.opacityCharacters=this.opacityTypes.opacityFull;break;default:this.opacityVoices=this.opacityTypes.opacityFull,this.opacityCircles=this.opacityTypes.opacityFull,this.opacityCharacters=this.opacityTypes.opacityDimmed}this.updateCircles()}assignPentadesToSelectors(){var e,t,s=this,i=this.preloadedPentade;i=i.minus(i.mod(1)),$.each(s.pentadeSelectors,function(r,o){e=i.plus(r),$(this).attr("pentade",e),t='<div class="info-text info-text-large">'+r+"</div>",t+='<div class="info-text info-text-small">'+e.toString()+"</div>",s.debug&&$(this).html(t)})}fetchVoiceLevels(){this.voiceLevels2=this.voiceLevels.map(function(e){return e.slice()}),this.bufferTime=0}setInitLeft(){this.buffer.offset({left:this.bufferMarginX*this.unit}),this.resetPentadeSelectorContainer()}resetPentadeSelectorContainer(){this.pentadeSelectorContainer.offset({left:(this.bufferMarginX-1)*this.unit})}markLevel(e,t,s){void 0===s&&(s=!1);var i="level-"+(e=parseInt(e)),r=this,o=this.canvasRC.getLayerGroup(i);void 0!==o?(s&&console.log("wesen: "+this.wesen),this.canvasRC.setLayerGroup(i,{strokeStyle:this.colors[t]}),$.each(o,function(e,t){r.canvasRC.moveLayer(t,1e3)})):e+1<=this.endLevel&&(this.wesen=e+1,this.markLevel(this.wesen,t,!0))}resizeStage(){this.getStageWidth(!1),this.getStageHeight(!1),this.stage.css("width",this.stageWidth+"px"),this.stage.css("height",this.stageHeight+"px"),this.stage.css("min-height",this.stageHeight+"px"),this.stage.css("max-height",this.stageHeight+"px"),this.width=Math.ceil(this.stageWidth/this.unit+2*this.preloadPositions)+5,this.showDebugInfo("bufferWidth",this.width),this.stageTop=this.stage.offset().top,this.resizeActors()}haveStageDimensionsChanged(){var e=this.getStageWidth(!0),t=this.getStageHeight(!0,e);return!(e==this.stageWidth&&t==this.stageHeight)}resizeActors(){var e=this.stageHeight/2-this.height*this.unit/2+this.stageTop;e<this.stageTop&&(e=this.stageTop),this.canvasRC.prop("height",(this.height-.5)*this.unit),this.canvasRC.prop("width",30*this.unit),this.canvasRC.offset({left:this.stageWidth/2-15*this.unit,top:e}),this.circlesOffsetX=Math.floor(this.stageWidth/this.unit/2)-this.bufferMarginX,this.canvasCircles.prop("height")!=this.height*this.unit&&this.canvasCircles.prop("height",this.height*this.unit),this.canvasCircles.prop("width")!=6*this.unit&&this.canvasCircles.prop("width",6*this.unit),this.canvasCircles.offset({left:(-3+this.circlesOffsetX)*this.unit+this.bufferMarginX*this.unit,top:e}),this.buffer2.offset({top:e}),this.buffer.offset({top:e}),this.pentadeSelectorContainer.offset({top:e+this.offsetY});var t=this.stageTop;this.scoreHeight=this.stageHeight,this.score2.offset({top:t}),this.score.offset({top:t}),this.score2.prop("height",this.scoreHeight),this.score.prop("height",this.scoreHeight),this.pageScale=1390/this.scoreHeight}showInfo(e){$("#info").text(e),this.show($("#info"))}hideInfo(){this.hide($("#info"))}synchronizeSuranadira(e){if(null==this.overridePentade&&!this.scoreEnabled){var t=this,s=null;s=this.getPosition(),this.showDebugInfo("expectedPosition",s.toString()),e.minus(s).abs().cmp(10)>=0&&(this.isSynchronizing=!0,this.stopTimer(),this.showInfo("Synchronizing Suranadira..."),this.hideSuranadira(),this.hideScore(),setTimeout(function(){t.reload()},1e3))}}getCurrentPentade(){var e=new Date,t=new Big(e.getTime()-this.tzOffset()),s=new Big(this.scoreTempo).times(5),i=new Big(t.div(s)).round(),r=Math.round(this.circlesOffsetX/5);if(i=i.minus(r),this.useEra){var o=new Big(this.pentadesPerDay).times("1000000000000000");i=i.plus(o)}return null!=this.overridePentade&&(i=this.overridePentade),i}getPosition(e){if(void 0===e)e=this.getCurrentPentade();return e.times(5)}setSuranadiraPosition(){this.preloadedPentade=this.getCurrentPentade(),this.showDebugInfo("preloadedPentade",this.preloadedPentade),this.preloadedPosition=this.getPosition(this.preloadedPentade),this.showDebugInfo("preloadedPosition",this.preloadedPosition),this.currentPosition=this.preloadedPosition.plus(this.circlesOffsetX),this.showDebugInfo("currentPosition",this.currentPosition)}redraw(){this.stopTimer(),this.canvas.removeLayers(),this.setSuranadiraPosition(),this.getVoiceLevels(this.getVoiceLevelsDefault()),this.calcDeltaForPentades(),this.drawSuranadira(),this.setupPentadeSelectors(),this.setupPentadeSelectorEvents(),this.loadFromBuffer(!1),this.setInitLeft();var e=this.stageHeight/2-this.height*this.offsetY;e<0&&(e=0),this.buffer.css("top",e+"px"),this.buffer2.css("top",e+"px"),this.canvasRC.css("top",e+"px"),this.canvasCircles.css("top",e+"px"),this.pentadeSelectorContainer.css("top",e+this.offsetY+"px"),this.drawCircles(),this.animationEnabled&&!this.scoreEnabled&&this.updateCircles(),this.onSuranadiraLoaded(),this.animationEnabled&&!this.scoreEnabled&&this.startTimer()}getContentTop(){var e=this.stageHeight/2-this.height*this.offsetY;return e<0&&(e=0),e+this.offsetY}compose(e,t,s){s|=0,void 0===e&&(e=!0);var i=!1,r=this.dec2delta(this.dec);null==this.endLevel&&(this.endLevel=this.dec2bin(this.dec).length-1),this.height=this.endLevel-this.startLevel+1,e&&this.resizeStage(!1),this.singleStrand=!0,this.currLevel=0;var o,a=0,h=[];r.reverse();var n={x:this.rcOffsetX,y:a},l=0,c=0,d=0,u=this;$.each(r,function(e,r){if(l>=u.endLevel)return!1;r=parseInt(r),c=l,u.currLevel+=r,o=u.chooseComponent(r,a,h.join("")),n=u.drawComponent(t,o,i,r,h.join(""),n.x,l,!1,s),"Z"==o||"S"==o?(l+=1,h.unshift(o+(r-1)),o=u.chooseComponent(r-1,a+1,null),i=n.strand,n=u.drawComponent(t,o,i,r-1,null,n.x,l,!0,s),l+=r-1,h.unshift(o+(r-1))):(l+=r,h.unshift(o+r)),u.currLevel<=u.endLevel+1&&u.mouseEventsAllowed&&u.drawHotspot(t,d,r,n.x,c),h=h.slice(0,2),i=n.strand,a=l,d++})}chooseComponent(e,t,s){return e%2==1&&0==t?"J":e%2==0&&0==t?"V":e>1&&t%2==0&&$.inArray(s,["I1J1","I1I1","I1U2"])>-1?"Z":e>1&&t%2==1&&$.inArray(s,["I1I1","I1N2"])>-1?"S":e%2==0&&t%2==0?"N":e%2==0&&t%2==1?"U":1==e?"I":e%2==1?"O":void console.log("undefined")}swapKeyValue(e){for(var t=[],s=0;s<e.length;s++)t[e[s]]=s;return t}getVoiceLevels(e){for(var t=this.groups,s=this.width,i=[],r=0;r<t+1;r++)i[r]=this.getVoiceLevelsGroup(e,r);var o=[];for(r=0;r<s+1;r++){o[r]=[];for(var a=0;a<t+1;a++)o[r]=o[r].concat(i[a][r]);0,o[r]=this.swapKeyValue(o[r])}return this.voiceLevels=o,o}getVoiceLevelsGroup(e,t){var s,i=this.width,r=this.height,o=new Big(this.preloadedPosition),a=this.groups,h=Math.floor(r/a),n=t*h,l=[],c=t*h;e=e.slice(c,c+h),l.push(e);for(var d=0;d<i;d++){s=[];for(var u=n;u<n+h;u++)s.push(this.logos(o.plus(d),u));e=this.rotateVoices(s,e),l.push(e)}return l}rotateVoices(e,t){for(var s=null,i=null,r=t.slice(0),o=0;o<e.length;o++)0==e[o]&&(null==s?i=o:r[o]=t[s],s=o);return i!=s&&(r[i]=t[s]),r}getVoiceLevelsDefault(){for(var e=this.height,t=[],s=0;s<e;s++)t[s]=s;return t}getVoiceLevelsCurrent(){return this.swapKeyValue(this.voiceLevels[this.preloadPositions])}logos(e,t){e=new Big(e);var s,i=Big(5).times(Big(2).pow(t)),r=s=e.mod(i).minus(i.times(4).div(10));return(s=s.cmp(0))<0?parseInt(r.mod(2)):parseInt(r.mod(3))}dec2delta(e){for(var t=-1,s=(e=new Big(e),new Big(2)),i=0,r=[];1==e.cmp(0);)i=s.pow(this.log2(e)),e=e.minus(i),t>-1&&r.push(t-this.log2(i)),t=this.log2(i);return r.push(t+1),r}log2(e){return this.dec2bin(e).length-1}dec2bin(e){Big.RM=0,e=new Big(e);for(var t,s=[0,1],i="";1==e.cmp(1);)t=e.mod(2).toFixed(0),e=e.div(2).toFixed(0),i=s[parseInt(t)]+i,e=new Big(e);return i=s[parseInt(e)]+i}getRandom(e=2){for(var t="",s=0;s<e;s++)t=(t+=Math.floor(1e6*Math.random())+1).toString();return t}tzOffset(){var e=new Date;return 60*e.getTimezoneOffset()*1e3}getMsSinceMidnight(e){return e-new Date(e).setHours(0,0,0,0)}hexToRgb(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,s,i){return t+t+s+s+i+i});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}rgbToHex(e,t,s){return"#"+((1<<24)+(e<<16)+(t<<8)+s).toString(16).slice(1)}rgbToHsl(e,t,s){e/=255,t/=255,s/=255;var i,r,o=Math.max(e,t,s),a=Math.min(e,t,s),h=(o+a)/2;if(o==a)i=r=0;else{var n=o-a;switch(r=h>.5?n/(2-o-a):n/(o+a),o){case e:i=(t-s)/n+(t<s?6:0);break;case t:i=(s-e)/n+2;break;case s:i=(e-t)/n+4}i/=6}return{h:i,s:r,l:h}}hslToRgb(e,t,s){var i,r,o;if(0==t)i=r=o=s;else{var a=s<.5?s*(1+t):s+t-s*t,h=2*s-a;i=this.hue2rgb(h,a,e+1/3),r=this.hue2rgb(h,a,e),o=this.hue2rgb(h,a,e-1/3)}return{r:Math.round(255*i),g:Math.round(255*r),b:Math.round(255*o)}}hue2rgb(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e}}